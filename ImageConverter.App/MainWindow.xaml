<ui:FluentWindow x:Class="ImageConverter.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:vm="clr-namespace:ImageConverter.ViewModels"
        mc:Ignorable="d"
        Title="Image Converter" 
        Height="720" 
        Width="520"
        MinHeight="600"
        MinWidth="480"
        WindowStartupLocation="CenterScreen"
        ExtendsContentIntoTitleBar="True"
        Icon="pack://application:,,,/Assets/app.ico">

    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <ui:TitleBar Grid.Row="0" Title="Image Converter" ShowMaximize="False">
            <ui:TitleBar.Icon>
                <ui:ImageIcon Source="pack://application:,,,/Assets/app.png" />
            </ui:TitleBar.Icon>
        </ui:TitleBar>

        <!-- Main Content -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="24,8,24,24">
                
                <!-- Source Image Section -->
                <ui:Card Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Source Image" 
                                   FontWeight="SemiBold" 
                                   FontSize="16" 
                                   Margin="0,0,0,12" />
                        
                        <!-- Drop Zone / File Selection -->
                        <Border BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                BorderThickness="2"
                                CornerRadius="8"
                                Background="{DynamicResource ControlFillColorDefaultBrush}"
                                Padding="24"
                                AllowDrop="True"
                                DragOver="OnDragOver"
                                Drop="OnDrop">
                            <StackPanel HorizontalAlignment="Center">
                                <ui:SymbolIcon Symbol="Image24" 
                                               FontSize="48" 
                                               HorizontalAlignment="Center"
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                
                                <TextBlock Text="{Binding SourceFilePath, Converter={StaticResource FileName}}"
                                           FontSize="14"
                                           HorizontalAlignment="Center"
                                           Margin="0,12,0,8"
                                           Visibility="{Binding IsImageLoaded, Converter={StaticResource BoolToVisibility}}" />
                                
                                <TextBlock Text="Drag &amp; drop an image here or click to browse"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                           HorizontalAlignment="Center"
                                           Margin="0,8,0,12"
                                           Visibility="{Binding IsImageLoaded, Converter={StaticResource BoolToVisibility}, ConverterParameter=Invert}" />
                                
                                <ui:Button Content="Browse..." 
                                           Appearance="Primary"
                                           Command="{Binding BrowseSourceCommand}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Border>

                        <!-- Image Info -->
                        <StackPanel Visibility="{Binding IsImageLoaded, Converter={StaticResource BoolToVisibility}}"
                                    Margin="0,16,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Format" 
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}" 
                                               FontSize="12" />
                                    <TextBlock Text="{Binding ImageInfo.DetectedFormat}" 
                                               FontWeight="SemiBold" />
                                </StackPanel>
                                
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Dimensions" 
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}" 
                                               FontSize="12" />
                                    <TextBlock Text="{Binding ImageInfo.Dimensions}" 
                                               FontWeight="SemiBold" />
                                </StackPanel>
                                
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="Size" 
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}" 
                                               FontSize="12" />
                                    <TextBlock Text="{Binding ImageInfo.FormattedFileSize}" 
                                               FontWeight="SemiBold" />
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </ui:Card>

                <!-- Output Format Section -->
                <ui:Card Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Output Format" 
                                   FontWeight="SemiBold" 
                                   FontSize="16" 
                                   Margin="0,0,0,12" />
                        
                        <ui:TextBlock Text="Convert to:" Margin="0,0,0,8" />
                        <ComboBox ItemsSource="{Binding AvailableFormats}"
                                  SelectedItem="{Binding SelectedFormat}"
                                  DisplayMemberPath="DisplayName"
                                  HorizontalAlignment="Stretch" />
                        
                        <!-- Quality Slider (for JPEG/WebP) -->
                        <StackPanel Visibility="{Binding ShowQualitySlider, Converter={StaticResource BoolToVisibility}}"
                                    Margin="0,16,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Quality" Grid.Column="0" />
                                <TextBlock Text="{Binding Quality, Converter={StaticResource QualityFormat}}" 
                                           Grid.Column="1"
                                           FontWeight="SemiBold" />
                            </Grid>
                            <Slider Minimum="1" 
                                    Maximum="100" 
                                    Value="{Binding Quality}" 
                                    TickFrequency="10"
                                    IsSnapToTickEnabled="False"
                                    Margin="0,8,0,0" />
                            <TextBlock Text="Lower quality = smaller file size" 
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       FontSize="12"
                                       Margin="0,4,0,0" />
                        </StackPanel>
                    </StackPanel>
                </ui:Card>

                <!-- Target Size Section -->
                <ui:Card Margin="0,0,0,16">
                    <StackPanel>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Target File Size" 
                                       FontWeight="SemiBold" 
                                       FontSize="16" 
                                       Grid.Column="0" />
                            <ui:ToggleSwitch IsChecked="{Binding UseTargetSize}" 
                                             Grid.Column="1" />
                        </Grid>
                        
                        <StackPanel Visibility="{Binding UseTargetSize, Converter={StaticResource BoolToVisibility}}"
                                    Margin="0,12,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Maximum size" Grid.Column="0" />
                                <TextBlock Text="{Binding TargetSizeKb, Converter={StaticResource SizeKbFormat}}" 
                                           Grid.Column="1"
                                           FontWeight="SemiBold" />
                            </Grid>
                            <Slider Minimum="10" 
                                    Maximum="5000" 
                                    Value="{Binding TargetSizeKb}" 
                                    TickFrequency="100"
                                    IsSnapToTickEnabled="False"
                                    Margin="0,8,0,0" />
                            <TextBlock Text="Quality will be adjusted automatically to meet target size" 
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       FontSize="12"
                                       Margin="0,4,0,0" />
                        </StackPanel>
                    </StackPanel>
                </ui:Card>

                <!-- Resize Section -->
                <ui:Card Margin="0,0,0,16">
                    <StackPanel>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Resize Image" 
                                       FontWeight="SemiBold" 
                                       FontSize="16" 
                                       Grid.Column="0" />
                            <ui:ToggleSwitch IsChecked="{Binding EnableResize}" 
                                             Grid.Column="1" />
                        </Grid>
                        
                        <StackPanel Visibility="{Binding EnableResize, Converter={StaticResource BoolToVisibility}}"
                                    Margin="0,12,0,0">
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="16" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Width" Margin="0,0,0,4" />
                                    <ui:NumberBox Value="{Binding TargetWidth, Mode=TwoWay}" 
                                                  Minimum="1" 
                                                  Maximum="10000"
                                                  SpinButtonPlacementMode="Compact" />
                                </StackPanel>
                                
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="Height" Margin="0,0,0,4" />
                                    <ui:NumberBox Value="{Binding TargetHeight, Mode=TwoWay}" 
                                                  Minimum="1" 
                                                  Maximum="10000"
                                                  SpinButtonPlacementMode="Compact" />
                                </StackPanel>
                            </Grid>
                            
                            <CheckBox Content="Maintain aspect ratio" 
                                      IsChecked="{Binding MaintainAspectRatio}" />
                        </StackPanel>
                    </StackPanel>
                </ui:Card>

                <!-- Output Options -->
                <ui:Card Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Output" 
                                   FontWeight="SemiBold" 
                                   FontSize="16" 
                                   Margin="0,0,0,12" />
                        
                        <TextBlock Text="Save to:" Margin="0,0,0,4" />
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <ui:TextBox Text="{Binding OutputPath, Mode=TwoWay}" 
                                        PlaceholderText="Output file path..."
                                        Grid.Column="0" />
                            <ui:Button Content="..."
                                       Command="{Binding BrowseOutputCommand}"
                                       Grid.Column="1"
                                       Margin="8,0,0,0"
                                       Width="40" />
                        </Grid>
                        
                        <CheckBox Content="Overwrite if file exists" 
                                  IsChecked="{Binding OverwriteExisting}"
                                  Margin="0,12,0,0" />
                    </StackPanel>
                </ui:Card>

                <!-- Convert Button and Status -->
                <ui:Card>
                    <StackPanel>
                        <ui:Button Content="Convert Image" 
                                   Appearance="Primary"
                                   Command="{Binding ConvertCommand}"
                                   IsEnabled="{Binding IsConverting, Converter={StaticResource InverseBool}}"
                                   HorizontalAlignment="Stretch"
                                   Height="48"
                                   FontSize="16" />
                        
                        <!-- Progress -->
                        <ui:ProgressRing IsIndeterminate="True"
                                         Visibility="{Binding IsConverting, Converter={StaticResource BoolToVisibility}}"
                                         Width="32"
                                         Height="32"
                                         Margin="0,16,0,0"
                                         HorizontalAlignment="Center" />
                        
                        <!-- Status Message -->
                        <TextBlock Text="{Binding StatusMessage}"
                                   Visibility="{Binding StatusMessage, Converter={StaticResource NullToVisibility}}"
                                   TextWrapping="Wrap"
                                   HorizontalAlignment="Center"
                                   Margin="0,12,0,0"
                                   FontSize="14" />
                        
                        <!-- Success Result -->
                        <StackPanel Visibility="{Binding LastResult.Success, Converter={StaticResource BoolToVisibility}, FallbackValue=Collapsed}"
                                    Margin="0,12,0,0">
                            <ui:Button Content="Open Output Folder"
                                       Appearance="Secondary"
                                       Command="{Binding OpenOutputFolderCommand}"
                                       HorizontalAlignment="Center"
                                       Icon="{ui:SymbolIcon FolderOpen24}" />
                        </StackPanel>
                    </StackPanel>
                </ui:Card>

                <!-- Settings Section -->
                <ui:Card Margin="0,16,0,0">
                    <Expander Header="Settings">
                        <StackPanel Margin="0,12,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Shell Integration" FontWeight="SemiBold" />
                                    <TextBlock Text="Add 'Convert Image...' to right-click menu"
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                               FontSize="12" />
                                </StackPanel>
                                
                                <ui:Button Content="{Binding IsShellIntegrated, Converter={StaticResource BoolToVisibility}, ConverterParameter=Invert}"
                                           Command="{Binding ToggleShellIntegrationCommand}"
                                           Grid.Column="1">
                                    <ui:Button.Style>
                                        <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsShellIntegrated}" Value="True">
                                                    <Setter Property="Content" Value="Remove" />
                                                    <Setter Property="Appearance" Value="Danger" />
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding IsShellIntegrated}" Value="False">
                                                    <Setter Property="Content" Value="Enable" />
                                                    <Setter Property="Appearance" Value="Primary" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ui:Button.Style>
                                </ui:Button>
                            </Grid>
                            
                            <TextBlock Text="Note: Enabling shell integration requires administrator privileges."
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       FontSize="12"
                                       TextWrapping="Wrap"
                                       Margin="0,8,0,0" />
                        </StackPanel>
                    </Expander>
                </ui:Card>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</ui:FluentWindow>
